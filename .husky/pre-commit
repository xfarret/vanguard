#!/bin/sh
# shellcheck disable=SC2039
set -e

# Couleurs
GREEN='\033[0;32m'
LIGHT_GREEN='\033[1;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
YELLOW='\033[0;33m'
LIGHT_MAGENTA='\033[1;35m'
BOLD='\033[1m'
DIM='\033[2m'
UNDERLINE='\033[4m'
BG_GREEN='\033[42m'
BG_RED='\033[41m'
BG_BLUE='\033[44m'
BG_YELLOW='\033[43m'
BLACK='\033[0;30m'
NC='\033[0m'

# Vérifie si une commande existe
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Récupère la version Laravel
get_laravel_version() {
    if [ -f composer.lock ]; then
        version=$(grep -A 1 '"name": "laravel/framework"' composer.lock | grep version | cut -d '"' -f 4)
        echo "${version:-Not found}"
    else
        echo "composer.lock not found"
    fi
}

# Affiche le logo
print_vanguard_logo() {
    printf "${LIGHT_MAGENTA}"
    printf " _    __                                     __\n"
    printf "| |  / /___ _____  ____ ___  ______ ______  / /\n"
    printf "| | / / __ \`/ __ \/ __ \`/ / / / __ \`/ ___/ / / \n"
    printf "| |/ / /_/ / / / / /_/ / /_/ / /_/ / /  _ / /  \n"
    printf "|___/\__,_/_/ /_/\__, /\__,_/\__,_/_/  (_)_/   \n"
    printf "                /____/                         \n"
    printf "${NC}\n"
}

# Affiche un header fancy
print_fancy_header() {
    title="$1"
    width=120
    line=$(printf '%*s' "$width" | tr ' ' '─')

    printf "${BLUE}┌${line}┐${NC}\n"
    printf "${BLUE}│ ${CYAN}%-$(($width - 2))s ${BLUE}│${NC}\n" "$title"
    printf "${BLUE}└${line}┘${NC}\n"
}

# Affiche une tâche
print_task() {
    printf "${CYAN}${BOLD}▶ %-45s${NC}" "$1"
}

# Affiche le résultat
print_result() {
    case "$1" in
        0) printf "${BG_GREEN}${WHITE} PASSED ${NC}" ;;
        1) printf "${BG_RED}${WHITE} FAILED ${NC}" ;;
        2) printf "${BG_BLUE}${WHITE} SKIPPED ${NC}" ;;
    esac
}

# Exécute une commande avec timing et affichage
run_command() {
    name="$1"
    command="$2"

    print_task "$name"
    start_time=$(date +%s.%N)
    output=$(sh -c "$command" 2>&1)
    exit_code=$?
    end_time=$(date +%s.%N)
    duration=$(echo "$end_time - $start_time" | bc)

    if [ "$exit_code" -eq 0 ]; then
        print_result 0
        printf " ${GREEN}(%.2fs) Success${NC}\n" "$duration"
        return 0
    else
        print_result 1
        printf " ${RED}(%.2fs)${NC}\n" "$duration"
        printf "\n${RED}Output:${NC}\n"
        echo "$output" | while IFS= read -r line; do
            case "$line" in
                *invalid\ format\ character*)
                    printf "${YELLOW}Warning: Invalid format character in output${NC}\n"
                    ;;
                *)
                    printf "%s\n" "$line"
                    ;;
            esac
        done
        printf "\n"
        return 1
    fi
}

# Liste des commandes à exécuter
commands="Running Static Analysis:./vendor/bin/phpstan analyse --no-progress
Running Pest tests:./vendor/bin/pest --parallel --dirty --bail
Checking Code Style:./vendor/bin/duster lint
Checking for Refactoring Opportunities:./vendor/bin/rector --no-progress-bar --dry-run
Checking Prettier formatting:npx prettier --check resources/
Building Assets:npm run build"

# Affichage initial
print_vanguard_logo
print_fancy_header "Pre-commit Quality Checks"
printf "\n"

failed_checks=""
skipped_checks=""

# Boucle sur les commandes
echo "$commands" | while IFS=':' read -r name cmd; do
    # Vérifie si la commande existe
    first_word=$(echo "$cmd" | cut -d' ' -f1)
    if ! command_exists "$first_word"; then
        print_task "$name"
        printf "${BG_YELLOW}${BLACK} SKIP ${NC} (Command not found)\n"
        skipped_checks="$skipped_checks $name"
        continue
    fi

    if ! run_command "$name" "$cmd"; then
        failed_checks="$failed_checks $name"
    fi
done

# Résumé final
print_fancy_header "Summary"
printf "\n"

if [ -z "$failed_checks" ] && [ -z "$skipped_checks" ]; then
    printf "${BG_GREEN}${WHITE} SUCCESS ${NC} ${LIGHT_GREEN}All pre-commit checks passed.${NC}\n"
else
    if [ -n "$failed_checks" ]; then
        printf "${BG_RED}${WHITE} FAILURE ${NC} The following checks failed:${NC}\n"
        for check in $failed_checks; do
            printf "  ✖ %s\n" "$check"
        done
    fi
    if [ -n "$skipped_checks" ]; then
        printf "${BG_YELLOW}${BLACK} WARNING ${NC} The following checks were skipped:\n"
        for check in $skipped_checks; do
            printf "  ⚠ %s\n" "$check"
        done
    fi
fi

exit_code=$(expr $(echo "$failed_checks" | wc -w) + $(echo "$skipped_checks" | wc -w))
exit "$exit_code"
